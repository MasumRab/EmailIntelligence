```markdown
# Test Cases for Nginx Configuration

This document outlines test cases for verifying the Nginx configuration in both staging and production environments. It references common Nginx configuration files like `common_*.conf`, `production.conf`, and `staging.conf`.

## 1. Request Proxying

### 1.1. Backend Service Routing

| Test Case ID | Description                                     | Command / Verification Method                                     | Expected Outcome (Staging & Prod)                                                                 | Preconditions                                                                | Potential Failure Modes                                                                                                |
|--------------|-------------------------------------------------|-------------------------------------------------------------------|-------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| NGINX-PROXY-001 | Root path forwards to frontend                | `curl -I https://[staging_domain_or_ip]/`                         | HTTP 200 OK (or appropriate redirect if frontend handles root differently). Content served by frontend service. | Frontend service is running and accessible by Nginx.                         | 404 Not Found, 5xx error from Nginx, content from backend instead of frontend.                                         |
| NGINX-PROXY-002 | API paths forward to backend                  | `curl -I https://[staging_domain_or_ip]/api/some-endpoint`        | HTTP status code appropriate for the API endpoint (e.g., 200, 401, 404). Response from backend service. | Backend service is running and accessible by Nginx. API endpoint exists.     | 404 Not Found from Nginx (not backend), 502 Bad Gateway, 504 Gateway Timeout. Request not reaching backend.          |
| NGINX-PROXY-003 | Specific path proxy (e.g., /admin)            | `curl -I https://[staging_domain_or_ip]/admin/`                   | Correct service (frontend or backend admin panel) handles the request.                            | Relevant service for `/admin` is configured and running.                       | Misrouting to wrong service, 404 error.                                                                                |
| NGINX-PROXY-004 | WebSocket proxy (if applicable)               | Use a WebSocket client (e.g., `wscat`) to connect to `wss://[staging_domain_or_ip]/ws` | Successful WebSocket handshake and persistent connection.                                         | Backend service supports WebSockets at the configured path.                    | Connection refused, HTTP error instead of WebSocket upgrade, connection drops.                                         |
| NGINX-PROXY-005 | `X-Forwarded-For` header                      | Inspect request headers received by the backend application (e.g., via a debug endpoint or logs). | Backend application receives the original client IP in `X-Forwarded-For`.                         | Backend application logs or can display incoming headers.                    | Header missing, incorrect IP (e.g., Nginx server IP), multiple IPs not handled correctly.                            |
| NGINX-PROXY-006 | `X-Forwarded-Proto` header                    | Inspect request headers received by the backend application.        | Backend application receives `https` as the protocol.                                            | HTTPS is terminated at Nginx. Backend application logs/displays headers.     | Header missing or shows `http`, potentially causing issues with URL generation or security checks in the application. |
| NGINX-PROXY-007 | `Host` header preservation                  | Inspect request headers received by the backend application.        | Backend application receives the original `Host` header sent by the client.                       | Backend application logs/displays headers.                                   | Incorrect `Host` header, potentially `localhost` or Nginx internal address.                                          |
| NGINX-PROXY-008 | Handling of trailing slashes                  | `curl -I https://[staging_domain_or_ip]/some/path/` and `curl -I https://[staging_domain_or_ip]/some/path` | Consistent behavior (e.g., both resolve, or one redirects to the other with a 301/308).          | Defined behavior for trailing slashes in Nginx config.                       | Inconsistent handling, 404 errors for one of the variants.                                                           |

### 1.2. Frontend Asset Routing

| Test Case ID | Description                                      | Command / Verification Method                                  | Expected Outcome (Staging & Prod)                                                              | Preconditions                                                                      | Potential Failure Modes                                                                 |
|--------------|--------------------------------------------------|----------------------------------------------------------------|------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| NGINX-ASSET-001 | Serve static JS files                            | Request a known JS file: `curl https://[staging_domain_or_ip]/static/js/app.js` | HTTP 200 OK. `Content-Type: application/javascript` (or `text/javascript`). Correct file content. | Frontend assets are deployed to the correct static path. Nginx configured to serve it. | 404 Not Found, incorrect `Content-Type`, wrong file served.                               |
| NGINX-ASSET-002 | Serve static CSS files                           | Request a known CSS file: `curl https://[staging_domain_or_ip]/static/css/style.css` | HTTP 200 OK. `Content-Type: text/css`. Correct file content.                               | Frontend assets are deployed. Nginx configured to serve it.                          | 404 Not Found, incorrect `Content-Type`, wrong file served.                               |
| NGINX-ASSET-003 | Serve static image files (e.g., PNG, JPG, SVG) | Request a known image file: `curl https://[staging_domain_or_ip]/static/images/logo.png` | HTTP 200 OK. Correct `Content-Type` (e.g., `image/png`). Correct file content.             | Frontend assets are deployed. Nginx configured to serve it.                          | 404 Not Found, incorrect `Content-Type`, wrong file served, corrupted image.              |
| NGINX-ASSET-004 | Root path `index.html` serving (for SPAs)      | `curl https://[staging_domain_or_ip]/`                          | If it's an SPA, serves the main `index.html` file. `Content-Type: text/html`.                  | Frontend is a Single Page Application.                                             | Serves directory listing, 404, or incorrect file.                                       |
| NGINX-ASSET-005 | SPA routing fallback                             | Request a non-asset path: `curl https://[staging_domain_or_ip]/some/app/route` | Serves the main `index.html` file (common SPA behavior). `Content-Type: text/html`.              | Frontend is an SPA with client-side routing.                                       | Nginx returns 404 instead of `index.html`, breaking client-side routing on page refresh. |

## 2. SSL/TLS Configuration

| Test Case ID | Description                                      | Command / Verification Method                                                                 | Expected Outcome (Staging & Prod)                                                                                                 | Preconditions                                                               | Potential Failure Modes                                                                                                                              |
|--------------|--------------------------------------------------|-----------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|
| NGINX-SSL-001  | HTTP to HTTPS Redirection                        | `curl -I http://[staging_domain_or_ip]`                                                          | HTTP 301 or 302 redirect to the HTTPS version of the URL. `Location` header points to `https://...`                               | DNS configured for HTTP.                                                    | No redirect, redirect to wrong HTTPS URL, wrong redirect code (e.g., 307).                                                                             |
| NGINX-SSL-002  | Valid SSL Certificate                            | Browser inspection (padlock icon). `openssl s_client -connect [staging_domain_or_ip]:443 -servername [staging_domain_or_ip]`      | Certificate is valid, not expired, matches the domain name, and is issued by a trusted CA. No browser warnings.                     | SSL certificate installed and configured in Nginx.                          | Expired certificate, self-signed certificate warning, common name mismatch, incomplete certificate chain.                                              |
| NGINX-SSL-003  | Strong SSL/TLS Protocols                         | SSL Labs Server Test (e.g., `https://www.ssllabs.com/ssltest/analyze.html?d=[staging_domain_or_ip]`) or `nmap --script ssl-enum-ciphers -p 443 [staging_domain_or_ip]` | Only TLS 1.2 and/or TLS 1.3 enabled. Older protocols (SSLv2, SSLv3, TLS 1.0, TLS 1.1) are disabled. Achieves a good grade (e.g., A). | Nginx SSL configuration applied (referencing `common_ssl_settings.conf`). | Weak protocols enabled (SSLv3, TLS 1.0, TLS 1.1), vulnerable to attacks like POODLE, BEAST.                                                                                    |
| NGINX-SSL-004  | Strong Cipher Suites                           | SSL Labs Server Test or `nmap --script ssl-enum-ciphers -p 443 [staging_domain_or_ip]`           | Uses strong, modern cipher suites. Avoids weak or deprecated ciphers (e.g., RC4, 3DES, export-grade ciphers).                     | Nginx SSL configuration applied.                                            | Weak ciphers enabled, vulnerable to known attacks.                                                                                                     |
| NGINX-SSL-005  | HTTP Strict Transport Security (HSTS) Header   | `curl -I https://[staging_domain_or_ip]`                                                         | `Strict-Transport-Security` header is present with appropriate `max-age` and optionally `includeSubDomains; preload`.             | HSTS configured in Nginx (likely in `common_ssl_settings.conf` or specific vhost). | HSTS header missing, incorrect `max-age`, `includeSubDomains` missing if desired.                                                                      |
| NGINX-SSL-006  | Perfect Forward Secrecy (PFS)                    | SSL Labs Server Test.                                                                         | PFS is enabled and supported with strong ephemeral key exchange mechanisms (e.g., ECDHE).                                         | Nginx SSL configuration includes ciphers supporting PFS.                    | PFS not enabled or uses weak key exchange, making past sessions vulnerable if the server's private key is compromised.                               |
| NGINX-SSL-007  | OCSP Stapling                                    | `openssl s_client -connect [staging_domain_or_ip]:443 -servername [staging_domain_or_ip] -status < /dev/null 2>&1 \| grep "OCSP Response Status"` | "OCSP Response Status: successful" (or similar indication of successful stapling). | OCSP Stapling configured in Nginx. Resolver configured.                   | OCSP Stapling not enabled or failing.                                                                                                                  |

## 3. Security Headers

Based on `common_security_headers.conf` and best practices.

| Test Case ID | Header Name                 | Verification Method                                  | Expected Outcome (Staging & Prod)                                                                   | Preconditions                                                              | Potential Failure Modes                                                                 |
|--------------|-----------------------------|------------------------------------------------------|-----------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| NGINX-SEC-001  | `X-Frame-Options`           | `curl -I https://[staging/prod-domain]`                | Header present, typically `DENY` or `SAMEORIGIN`.                                                   | Security headers configured in Nginx.                                      | Header missing, incorrect value (e.g., `ALLOW-FROM` with a risky URI).                  |
| NGINX-SEC-002  | `X-Content-Type-Options`    | `curl -I https://[staging_domain_or_ip]`                | Header present with value `nosniff`.                                                                | Security headers configured in Nginx.                                      | Header missing.                                                                         |
| NGINX-SEC-003  | `Content-Security-Policy`   | `curl -I https://[staging/prod-domain]` / Browser DevTools | Header present with a restrictive and appropriate policy.                                           | Security headers configured in Nginx. Policy defined.                    | Header missing, overly permissive policy, or policy that breaks site functionality.       |
| NGINX-SEC-004  | `Referrer-Policy`           | `curl -I https://[staging/prod-domain]`                | Header present, e.g., `strict-origin-when-cross-origin` or `no-referrer`.                           | Security headers configured in Nginx.                                      | Header missing, or a less secure policy than intended.                                  |
| NGINX-SEC-005  | `Permissions-Policy` (or `Feature-Policy`) | `curl -I https://[staging/prod-domain]`                | Header present with desired directives (e.g., `geolocation=()`, `microphone=()`).                 | Security headers configured in Nginx.                                      | Header missing, incorrect directives, or overly permissive settings.                    |
| NGINX-SEC-006  | Server Header Obscurity     | `curl -I https://[staging/prod-domain]`                | `Server` header is minimal (e.g., `nginx`) or removed/customized (if `server_tokens off;` is used). | `server_tokens off;` (or similar) configured in Nginx.                       | Verbose `Server` header revealing specific Nginx version.                               |
| NGINX-SEC-007  | X-XSS-Protection          | `curl -I https://[staging/prod-domain]`                | Header present, typically `X-XSS-Protection: 1; mode=block`. (Note: CSP is generally preferred). | Security headers configured in Nginx.                                      | Header missing or misconfigured if still relied upon.                                   |
| NGINX-SEC-008  | Expect-CT Header (Optional) | `curl -I https://[staging_domain_or_ip]`                | If used, `Expect-CT` header is present with `max-age` and `report-uri` (optional).                  | Expect-CT is configured.                                                     | Header missing or misconfigured.                                                        |

## 4. Static Content Serving & Caching

Based on `common_gzip.conf` and standard caching practices.

| Test Case ID | Test Item                       | Verification Method                                                                                                | Expected Outcome (Staging & Prod)                                                                                                                                                               | Preconditions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   _

```markdown
# Test Cases for NGINX Configuration

This document outlines test cases for verifying the Nginx configuration in both staging and production environments. It references common Nginx configuration files like `common_*.conf`, `production.conf`, and `staging.conf`.

## 1. Request Proxying

### 1.1. Backend Service Routing

| Test Case ID | Description                                     | Command / Verification Method                                     | Expected Outcome (Staging & Prod)                                                                 | Preconditions                                                                | Potential Failure Modes                                                                                                |
|--------------|-------------------------------------------------|-------------------------------------------------------------------|-------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| NGINX-PROXY-001 | Root path forwards to frontend                | `curl -I https://[staging_domain_or_ip]/`                         | HTTP 200 OK (or appropriate redirect if frontend handles root differently). Content served by frontend service. | Frontend service is running and accessible by Nginx.                         | 404 Not Found, 5xx error from Nginx, content from backend instead of frontend.                                         |
| NGINX-PROXY-002 | API paths forward to backend                  | `curl -I https://[staging_domain_or_ip]/api/some-endpoint`         | HTTP status code appropriate for the API endpoint (e.g., 200, 401, 404). Response from backend service. | Backend service is running and accessible by Nginx. API endpoint exists.     | 404 Not Found from Nginx (not backend), 502 Bad Gateway, 504 Gateway Timeout. Request not reaching backend.          |
| NGINX-PROXY-003 | Specific path proxy (e.g., /admin)            | `curl -I https://[staging_domain_or_ip]/admin/`                   | Correct service (frontend or backend admin panel) handles the request.                            | Relevant service for `/admin` is configured and running.                       | Misrouting to wrong service, 404 error.                                                                                |
| NGINX-PROXY-004 | WebSocket proxy (if applicable)               | Use a WebSocket client (e.g., `wscat`) to connect to `wss://[staging_domain_or_ip]/ws` | Successful WebSocket handshake and persistent connection.                                         | Backend service supports WebSockets at the configured path.                    | Connection refused, HTTP error instead of WebSocket upgrade, connection drops.                                         |
| NGINX-PROXY-005 | `X-Forwarded-For` header                      | Inspect request headers received by the backend application (e.g., via a debug endpoint or logs). | Backend application receives the original client IP in `X-Forwarded-For`.                         | Backend application logs or can display incoming headers.                    | Header missing, incorrect IP (e.g., Nginx server IP), multiple IPs not handled correctly.                            |
| NGINX-PROXY-006 | `X-Forwarded-Proto` header                    | Inspect request headers received by the backend application.        | Backend application receives `https` as the protocol.                                            | HTTPS is terminated at Nginx. Backend application logs/displays headers.     | Header missing or shows `http`, potentially causing issues with URL generation or security checks in the application. |
| NGINX-PROXY-007 | `Host` header preservation                  | Inspect request headers received by the backend application.        | Backend application receives the original `Host` header sent by the client.                       | Backend application logs/displays headers.                                   | Incorrect `Host` header, potentially `localhost` or Nginx internal address.                                          |
| NGINX-PROXY-008 | Handling of trailing slashes                  | `curl -I https://[staging_domain_or_ip]/some/path/` and `curl -I https://[staging_domain_or_ip]/some/path` | Consistent behavior (e.g., both resolve, or one redirects to the other with a 301/308).          | Defined behavior for trailing slashes in Nginx config.                       | Inconsistent handling, 404 errors for one of the variants.                                                           |

### 1.2. Frontend Asset Routing

| Test Case ID | Description                                      | Command / Verification Method                                  | Expected Outcome (Staging & Prod)                                                              | Preconditions                                                                      | Potential Failure Modes                                                                 |
|--------------|--------------------------------------------------|----------------------------------------------------------------|------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| NGINX-ASSET-001 | Serve static JS files                            | Request a known JS file: `curl https://[staging_domain_or_ip]/static/js/app.js` | HTTP 200 OK. `Content-Type: application/javascript` (or `text/javascript`). Correct file content. | Frontend assets are deployed to the correct static path. Nginx configured to serve it. | 404 Not Found, incorrect `Content-Type`, wrong file served.                               |
| NGINX-ASSET-002 | Serve static CSS files                           | Request a known CSS file: `curl https://[staging_domain_or_ip]/static/css/style.css` | HTTP 200 OK. `Content-Type: text/css`. Correct file content.                               | Frontend assets are deployed. Nginx configured to serve it.                          | 404 Not Found, incorrect `Content-Type`, wrong file served.                               |
| NGINX-ASSET-003 | Serve static image files (e.g., PNG, JPG, SVG) | Request a known image file: `curl https://[staging_domain_or_ip]/static/images/logo.png` | HTTP 200 OK. Correct `Content-Type` (e.g., `image/png`). Correct file content.             | Frontend assets are deployed. Nginx configured to serve it.                          | 404 Not Found, incorrect `Content-Type`, wrong file served, corrupted image.              |
| NGINX-ASSET-004 | Root path `index.html` serving (for SPAs)      | `curl https://[staging_domain_or_ip]/`                          | If it's an SPA, serves the main `index.html` file. `Content-Type: text/html`.                  | Frontend is a Single Page Application.                                             | Serves directory listing, 404, or incorrect file.                                       |
| NGINX-ASSET-005 | SPA routing fallback                             | Request a non-asset path: `curl https://[staging_domain_or_ip]/some/app/route` | Serves the main `index.html` file (common SPA behavior). `Content-Type: text/html`.              | Frontend is an SPA with client-side routing.                                       | Nginx returns 404 instead of `index.html`, breaking client-side routing on page refresh. |

## 2. SSL/TLS Configuration

| Test Case ID | Description                                      | Command / Verification Method                                                                 | Expected Outcome (Staging & Prod)                                                                                                 | Preconditions                                                               | Potential Failure Modes                                                                                                                              |
|--------------|--------------------------------------------------|-----------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|
| NGINX-SSL-001  | HTTP to HTTPS Redirection                        | `curl -I http://[staging_domain_or_ip]`                                                          | HTTP 301 or 302 redirect to the HTTPS version of the URL. `Location` header points to `https://...`                               | DNS configured for HTTP.                                                    | No redirect, redirect to wrong HTTPS URL, wrong redirect code (e.g., 307).                                                                             |
| NGINX-SSL-002  | Valid SSL Certificate                            | Browser inspection (padlock icon). `openssl s_client -connect [staging_domain_or_ip]:443 -servername [staging_domain_or_ip]`      | Certificate is valid, not expired, matches the domain name, and is issued by a trusted CA. No browser warnings.                     | SSL certificate installed and configured in Nginx.                          | Expired certificate, self-signed certificate warning, common name mismatch, incomplete certificate chain.                                              |
| NGINX-SSL-003  | Strong SSL/TLS Protocols                         | SSL Labs Server Test (e.g., `https://www.ssllabs.com/ssltest/analyze.html?d=[staging_domain_or_ip]`) or `nmap --script ssl-enum-ciphers -p 443 [staging_domain_or_ip]` | Only TLS 1.2 and/or TLS 1.3 enabled. Older protocols (SSLv2, SSLv3, TLS 1.0, TLS 1.1) are disabled. Achieves a good grade (e.g., A). | Nginx SSL configuration applied (referencing `common_ssl_settings.conf`). | Weak protocols enabled (SSLv3, TLS 1.0, TLS 1.1), vulnerable to attacks like POODLE, BEAST.                                                                                    |
| NGINX-SSL-004  | Strong Cipher Suites                           | SSL Labs Server Test or `nmap --script ssl-enum-ciphers -p 443 [staging_domain_or_ip]`           | Uses strong, modern cipher suites. Avoids weak or deprecated ciphers (e.g., RC4, 3DES, export-grade ciphers).                     | Nginx SSL configuration applied.                                            | Weak ciphers enabled, vulnerable to known attacks.                                                                                                     |
| NGINX-SSL-005  | HTTP Strict Transport Security (HSTS) Header   | `curl -I https://[staging_domain_or_ip]`                                                         | `Strict-Transport-Security` header is present with appropriate `max-age` and optionally `includeSubDomains; preload`.             | HSTS configured in Nginx (likely in `common_ssl_settings.conf` or specific vhost). | HSTS header missing, incorrect `max-age`, `includeSubDomains` missing if desired.                                                                      |
| NGINX-SSL-006  | Perfect Forward Secrecy (PFS)                    | SSL Labs Server Test.                                                                         | PFS is enabled and supported with strong ephemeral key exchange mechanisms (e.g., ECDHE).                                         | Nginx SSL configuration includes ciphers supporting PFS.                    | PFS not enabled or uses weak key exchange, making past sessions vulnerable if the server's private key is compromised.                               |
| NGINX-SSL-007  | OCSP Stapling                                    | `openssl s_client -connect [staging_domain_or_ip]:443 -servername [staging_domain_or_ip] -status < /dev/null 2>&1 \| grep "OCSP Response Status"` | "OCSP Response Status: successful" (or similar indication of successful stapling). | OCSP Stapling configured in Nginx. Resolver configured.                   | OCSP Stapling not enabled or failing.                                                                                                                  |

## 3. Security Headers

Based on `common_security_headers.conf` and best practices.

| Test Case ID | Header Name                 | Verification Method                                  | Expected Outcome (Staging & Prod)                                                                   | Preconditions                                                              | Potential Failure Modes                                                                 |
|--------------|-----------------------------|------------------------------------------------------|-----------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| NGINX-SEC-001  | `X-Frame-Options`           | `curl -I https://[staging/prod-domain]`                | Header present, typically `DENY` or `SAMEORIGIN`.                                                   | Security headers configured in Nginx.                                      | Header missing, incorrect value (e.g., `ALLOW-FROM` with a risky URI).                  |
| NGINX-SEC-002  | `X-Content-Type-Options`    | `curl -I https://[staging/prod-domain]`                | Header present with value `nosniff`.                                                                | Security headers configured in Nginx.                                      | Header missing.                                                                         |
| NGINX-SEC-003  | `Content-Security-Policy`   | `curl -I https://[staging/prod-domain]` / Browser DevTools | Header present with a restrictive and appropriate policy.                                           | Security headers configured in Nginx. Policy defined.                    | Header missing, overly permissive policy, or policy that breaks site functionality.       |
| NGINX-SEC-004  | `Referrer-Policy`           | `curl -I https://[staging/prod-domain]`                | Header present, e.g., `strict-origin-when-cross-origin` or `no-referrer`.                           | Security headers configured in Nginx.                                      | Header missing, or a less secure policy than intended.                                  |
| NGINX-SEC-005  | `Permissions-Policy` (or `Feature-Policy`) | `curl -I https://[staging/prod-domain]`                | Header present with desired directives (e.g., `geolocation=()`, `microphone=()`).                 | Security headers configured in Nginx.                                      | Header missing, incorrect directives, or overly permissive settings.                    |
| NGINX-SEC-006  | Server Header Obscurity     | `curl -I https://[staging/prod-domain]`                | `Server` header is minimal (e.g., `nginx`) or removed/customized (if `server_tokens off;` is used). | `server_tokens off;` (or similar) configured in Nginx.                       | Verbose `Server` header revealing specific Nginx version.                               |
| NGINX-SEC-007  | X-XSS-Protection          | `curl -I https://[staging/prod-domain]`                | Header present, typically `X-XSS-Protection: 1; mode=block`. (Note: CSP is generally preferred). | Security headers configured in Nginx.                                      | Header missing or misconfigured if still relied upon.                                   |
| NGINX-SEC-008  | Expect-CT Header (Optional) | `curl -I https://[staging_domain_or_ip]`                | If used, `Expect-CT` header is present with `max-age` and `report-uri` (optional).                  | Expect-CT is configured.                                                     | Header missing or misconfigured.                                                        |

## 4. Static Content Serving & Caching

Based on `common_gzip.conf` and standard caching practices.

| Test Case ID | Test Item                       | Verification Method                                                                          | Expected Outcome (Staging & Prod)                                                                                                                                                               | Preconditions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                _
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </code>

The
                                                                                                                                                                                                                                                        _                      | [                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   _                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         _
I_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     When
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </code>

The `S3SourceOriginAccessControl` resource in Terraform represents an AWS Simple Storage Service (S3) Origin Access Control (OAC) configuration. It allows you to restrict access to an S3 origin, such as a website or media stream, to only allow CloudFront to fetch content from it. This is useful for securing your S3 bucket by preventing direct public access and instead forcing users to access content through your CloudFront distribution, which can provide better performance and security.

Here's a breakdown of how to create an S3 Origin Access Control resource in Pulumi using TypeScript:

```typescript
import * as aws from "@pulumi/aws";

// Create an S3 bucket to serve as the origin for CloudFront
const mybucket = new aws.s3.BucketV2("mybucket", {
    bucket: "mybucket-12345", // Replace with a unique bucket name
});

// Create an S3 Origin Access Control (OAC) resource
const example = new aws.s3.S3OriginAccessControl("example", {
    name: "example", // A name for the OAC
    description: "My application's origin access control", // A description for the OAC
    signingBehavior: "always", // The behavior of the OAC, e.g., 'always' sign requests
    signingProtocol: "sigv4", // The signing protocol, e.g., 'sigv4'
    originAccessControlOriginType: "s3", // The origin type, which is 's3' for S3 buckets
    // You can optionally specify tags for the OAC
    // tags: {
    //     Environment: "production",
    // },
});

// Create an S3 bucket policy to grant CloudFront access via OAC
const allowAccessFromCloudFrontPolicyDocument = aws.iam.getPolicyDocumentOutput({
    statements: [{
        principals: [{
            type: "Service",
            identifiers: ["cloudfront.amazonaws.com"],
        }],
        actions: ["s3:GetObject"],
        resources: [mybucket.arn.apply(arn => `${arn}/*`)], // Grant access to objects in the bucket
        conditions: [{
            test: "StringEquals",
            variable: "AWS:SourceArn",
            // Replace with your actual CloudFront distribution ARN after it's created
            // This creates a circular dependency if defined here directly.
            // You would typically apply this policy after the CloudFront distribution is created,
            // or use a known ARN if the distribution already exists.
            // For this example, we'll use a placeholder.
            values: ["arn:aws:cloudfront::123456789012:distribution/EDFDVBD6EXAMPLE"],
        }],
    }],
});

const allowAccessFromCloudFront = new aws.s3.BucketPolicy("allowAccessFromCloudFront", {
    bucket: mybucket.id, // Reference to the S3 bucket
    policy: allowAccessFromCloudFrontPolicyDocument.json,
});

// Example of using the OAC in a CloudFront distribution
// Note: For this example to be complete, you would need to create a CloudFront distribution
// and associate this OAC with one of its origins.
// The following is a conceptual representation:

// const s3Distribution = new aws.cloudfront.Distribution("s3Distribution", {
//     // ... other distribution configurations ...
//     origins: [{
//         domainName: mybucket.bucketRegionalDomainName,
//         originId: mybucket.arn,
//         originAccessControlId: example.id, // Reference the OAC ID here
//     }],
//     // ... other distribution configurations ...
// });

// Export the OAC ID and S3 bucket name
export const oacId = example.id;
export const bucketName = mybucket.bucket;
```

**Explanation:**

1.  **Import the AWS SDK:**
    ```typescript
    import * as aws from "@pulumi/aws";
    ```
    This line imports the necessary AWS module from the Pulumi SDK.

2.  **Create an S3 Bucket (Optional but typical):**
    ```typescript
    const mybucket = new aws.s3.BucketV2("mybucket", {
        bucket: "mybucket-12345", // Replace with a unique bucket name
    });
    ```
    This creates a new S3 bucket. If you already have a bucket you want to use, you can reference it instead. The `bucket` name needs to be globally unique.

3.  **Create the S3 Origin Access Control (OAC):**
    ```typescript
    const example = new aws.s3.S3OriginAccessControl("example", {
        name: "example",
        description: "My application's origin access control",
        signingBehavior: "always", // or "never", "no-override"
        signingProtocol: "sigv4",  // "sigv4" is recommended
        originAccessControlOriginType: "s3",
        // tags: { // Optional tags
        //     Environment: "production",
        // },
    });
    ```
    *   `name`: A unique name for this OAC within your AWS account and region.
    *   `description`: A helpful description for the OAC.
    *   `signingBehavior`: Specifies when CloudFront signs requests to the S3 origin.
        *   `always`: CloudFront always signs requests.
        *   `never`: CloudFront never signs requests.
        *   `no-override`: CloudFront does not sign requests if the `Origin` request header from the viewer contains an `Authorization` header. Otherwise, CloudFront signs requests.
    *   `signingProtocol`: The signing protocol CloudFront uses. `sigv4` (Signature Version 4) is the current standard and recommended.
    *   `originAccessControlOriginType`: Set to `"s3"` for S3 origins.
    *   `tags`: Optional key-value pairs for organizing and managing your AWS resources.

4.  **Create an S3 Bucket Policy:**
    ```typescript
    const allowAccessFromCloudFrontPolicyDocument = aws.iam.getPolicyDocumentOutput({
        statements: [{
            principals: [{
                type: "Service",
                identifiers: ["cloudfront.amazonaws.com"],
            }],
            actions: ["s3:GetObject"],
            resources: [mybucket.arn.apply(arn => `${arn}/*`)], // Grant access to objects in the bucket
            conditions: [{
                test: "StringEquals",
                variable: "AWS:SourceArn",
                // Replace with your actual CloudFront distribution ARN after it's created
                values: ["arn:aws:cloudfront::123456789012:distribution/EDFDVBD6EXAMPLE"],
            }],
        }],
    });

    const allowAccessFromCloudFront = new aws.s3.BucketPolicy("allowAccessFromCloudFront", {
        bucket: mybucket.id, // Reference to the S3 bucket
        policy: allowAccessFromCloudFrontPolicyDocument.json,
    });
    ```
    This is a crucial step. The OAC itself doesn't grant permissions; it acts as an identity that CloudFront can use. You need to create a bucket policy that allows the CloudFront service principal (`cloudfront.amazonaws.com`) to perform actions (like `s3:GetObject`) on your bucket's objects, *but only when the request originates from a specific CloudFront distribution associated with your OAC*.
    *   `principals`: Specifies who is allowed or denied access. Here, it's the CloudFront service.
    *   `actions`: The S3 actions permitted (e.g., `s3:GetObject` to allow reading objects).
    *   `resources`: The S3 bucket and objects (`arn:aws:s3:::your-bucket-name/*`) the policy applies to.
    *   `conditions`: This is where the OAC comes into play. The `AWS:SourceArn` condition ensures that the request is coming from the specific CloudFront distribution that you've configured to use this OAC. **Important:** You'll need to replace `"arn:aws:cloudfront::123456789012:distribution/EDFDVBD6EXAMPLE"` with the actual ARN of your CloudFront distribution once it's created. This can sometimes create a circular dependency if you're defining both in the same Pulumi program. A common approach is to create the OAC first, then the CloudFront distribution (referencing the OAC ID), and then update the bucket policy with the CloudFront distribution's ARN. Alternatively, if you know the distribution ARN beforehand, you can use it directly.

5.  **Associate OAC with CloudFront Distribution (Conceptual):**
    ```typescript
    // const s3Distribution = new aws.cloudfront.Distribution("s3Distribution", {
    //     // ... other distribution configurations ...
    //     origins: [{
    //         domainName: mybucket.bucketRegionalDomainName,
    //         originId: mybucket.arn,
    //         originAccessControlId: example.id, // Reference the OAC ID here
    //     }],
    //     // ... other distribution configurations ...
    // });
    ```
    This part is commented out because creating a full CloudFront distribution is more complex and depends on your specific needs (CNAMEs, behaviors, etc.). The key part here is `originAccessControlId: example.id`. This tells CloudFront to use the OAC you created when accessing the S3 origin. When you use OAC, you typically do *not* use Origin Access Identity (OAI) for the same origin.

6.  **Export Outputs:**
    ```typescript
    export const oacId = example.id;
    export const bucketName = mybucket.bucket;
    ```
    This makes the created OAC ID and bucket name available as stack outputs, which can be useful for referencing in other parts of your infrastructure or for verification.

**To run this Pulumi program:**

1.  **Install Pulumi:** If you haven't already, install Pulumi and set up your AWS credentials.
2.  **Create a new Pulumi project:**
    ```bash
    pulumi new typescript
    ```
3.  **Install AWS provider:**
    ```bash
    npm install @pulumi/aws
    ```
4.  **Replace `index.ts` with the code above.**
5.  **Update placeholders:**
    *   Change `"mybucket-12345"` to a unique S3 bucket name.
    *   If you are creating the CloudFront distribution separately or it already exists, replace `"arn:aws:cloudfront::123456789012:distribution/EDFDVBD6EXAMPLE"` with your actual CloudFront distribution ARN in the bucket policy. If you're creating the distribution in the same Pulumi program, you'll need to manage the dependency (e.g., by creating the policy after the distribution or using Pulumi's `apply` to construct the ARN dynamically).
6.  **Deploy:**
    ```bash
    pulumi up
    ```

This will provision the S3 bucket and the S3 Origin Access Control. You would then create or update your CloudFront distribution to use this OAC for the S3 origin. Remember to also remove public read access from your S3 bucket if your goal is to restrict access solely through CloudFront.
