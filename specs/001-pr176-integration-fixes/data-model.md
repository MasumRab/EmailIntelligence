# Data Model: Generic PR Integration Fixes

**Feature**: PR Integration Fixes
**Branch**: `001-pr176-integration-fixes`
**Date**: 2025-11-26
**Generated by**: `/speckit.plan` command

## Overview

This document defines the data models and structures required for the generic PR integration fixes feature. It describes the entities involved in PR management and the relationships between them.

## Core Entities

### PRSpecification
```typescript
interface PRSpecification {
    prNumber: string | number;    // The PR number provided as user input
    targetBranch: string;         // Target branch for the PR (default: main)
    sourceBranch: string;         // Source branch of the PR
    title: string;               // Title of the PR
    description: string;         // Description of the PR
    author: string;              // Author of the PR
    createdAt: Date;             // Creation date of the PR
    updatedAt: Date;             // Last updated date of the PR
    state: 'open' | 'closed' | 'merged'; // Current state of the PR
}
```

### PRDetails
```typescript
interface PRDetails {
    id: string;                  // GitHub ID of the PR
    number: number;              // PR number
    title: string;              // Title of the PR
    body: string;               // Body/description of the PR
    state: 'open' | 'closed';   // Current state
    locked: boolean;            // Whether the PR is locked
    hidden: boolean;            // Whether the PR is hidden
    author: {
        login: string;          // Author's GitHub username
        id: string;            // Author's GitHub ID
    };
    mergeable: 'MERGEABLE' | 'CONFLICTING' | 'UNKNOWN'; // Merge status
    mergeStateStatus: string;   // Detailed merge state
    labels: string[];           // Labels applied to the PR
    assignees: string[];        // Users assigned to the PR
    requestedReviewers: string[]; // Users requested for review
    reviews: Review[];          // All reviews on the PR
    comments: Comment[];        // All comments on the PR
    changedFiles: ChangedFile[]; // Files changed in the PR
}
```

### Comment
```typescript
interface Comment {
    id: string;                 // Comment ID
    body: string;              // Comment content
    author: {
        login: string;         // Author's GitHub username
        id: string;           // Author's GitHub ID
    };
    state: 'COMMENTED' | 'APPROVED' | 'CHANGES_REQUESTED' | 'DISMISSED';
    createdAt: Date;           // When the comment was created
    updatedAt: Date;           // When the comment was last updated
    path: string;              // File path (for line comments)
    line: number | null;       // Line number (for line comments)
    side: 'LEFT' | 'RIGHT' | null; // Side of diff (for line comments)
}
```

### Review
```typescript
interface Review {
    id: string;                // Review ID
    state: 'APPROVED' | 'CHANGES_REQUESTED' | 'COMMENTED' | 'PENDING';
    body: string;             // Review comment body
    author: {
        login: string;        // Author's GitHub username
        id: string;          // Author's GitHub ID
    };
    submittedAt: Date | null;  // When the review was submitted
    comments: Comment[];      // Comments made as part of this review
}
```

### ChangedFile
```typescript
interface ChangedFile {
    path: string;              // File path
    additions: number;         // Number of additions
    deletions: number;         // Number of deletions
    changes: number;          // Total changes
    status: 'added' | 'removed' | 'modified' | 'renamed' | 'copied';
    previousFileName?: string; // Previous file name (for renames)
    blobUrl: string;          // URL to the file blob
    rawUrl: string;           // URL to the raw file
    contentsUrl: string;      // URL to the file contents API
}
```

### IntegrationTask
```typescript
interface IntegrationTask {
    id: string;                // Unique task ID
    prNumber: number;          // Associated PR number
    type: 'COMMENT_RESOLUTION' | 'MERGE_CONFLICT' | 'FEATURE_GAP' | 'ARCHITECTURE_ALIGN' | 'DOCUMENTATION';
    priority: 'P1' | 'P2' | 'P3' | 'P4';
    description: string;       // Task description
    status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'FAILED';
    assignedTo: string | null; // User assigned to the task
    createdAt: Date;          // When the task was created
    completedAt: Date | null;  // When the task was completed
    dependencies: string[];   // IDs of dependent tasks
    affectedFiles: string[];  // Files affected by this task
}
```

### IntegrationResult
```typescript
interface IntegrationResult {
    prNumber: number;          // The PR number that was integrated
    status: 'SUCCESS' | 'PARTIAL_SUCCESS' | 'FAILED';
    completedTasks: IntegrationTask[];
    failedTasks: IntegrationTask[];
    conflicts: string[];       // List of unresolved conflicts
    issues: string[];         // List of issues encountered
    warnings: string[];       // List of warnings
    timestamp: Date;          // When the integration was performed
    summary: string;          // Summary of the integration results
    nextSteps: string[];      // Recommended next steps
}
```

## Data Flow

### Input Flow
1. User provides PR number as input
2. System validates the PR number format
3. System retrieves PR details from GitHub using GitHub CLI
4. PR details are parsed into PRSpecification and PRDetails objects

### Processing Flow
1. PRDetails are analyzed to identify comments, reviews, and merge conflicts
2. IntegrationTasks are created for each issue that needs resolution
3. Tasks are prioritized based on user stories (P1-P4)
4. Tasks are executed according to the priority and dependency order

### Output Flow
1. Integration results are collected in IntegrationResult object
2. Status updates are provided to the user during processing
3. Final integration summary is generated
4. Documentation is updated with integration details

## Validation Rules

### PR Number Validation
- Must be a positive integer
- Must exist in the GitHub repository
- User must have access permissions to view the PR

### PR State Validation
- PR must be open and in a mergeable state (though conflicts may exist)
- PR should not be in a draft state if it's to be processed immediately

### Task Dependency Validation
- No circular dependencies between tasks
- All dependency requirements must be satisfied before task execution

## Error Handling Models

### API Error Model
```typescript
interface APIError {
    status: number;            // HTTP status code
    message: string;          // Error message from API
    documentationUrl: string; // URL to relevant documentation
    details: any;             // Additional error details
}
```

### Validation Error Model
```typescript
interface ValidationError {
    field: string;            // Field that failed validation
    value: any;              // Value that failed validation
    constraint: string;      // Constraint that was violated
    message: string;         // Human-readable error message
}
```

## Relationships

- **PRSpecification** has many **IntegrationTask** objects
- **PRDetails** contains many **Comment** and **Review** objects  
- **IntegrationTask** may depend on other **IntegrationTask** objects
- **IntegrationResult** aggregates the results of multiple **IntegrationTask** objects

This data model supports the parameterization of PR numbers and provides a structure for managing the integration of any PR number provided as user input.

## Automation Framework Entities

### AutomationConfig
Represents configuration options for the automation framework.

```typescript
interface AutomationConfig {
  prNumber: number;           // PR number to process (can be overridden by input)
  targetBranch: string;       // Target branch for integration (default: main)
  automationLevel: "dry-run" | "interactive" | "full-automation"; // Level of automation
  notifications: {
    console: boolean;         // Enable console output
    logFile: string | null;   // Path to log file (null to disable)
    email: string | null;     // Email for notifications (null to disable)
  };
  auth: {
    method: "gh-cli" | "token"; // Authentication method to use
    token?: string;           // Token for API access (if using token auth)
  };
  loggingLevel: "debug" | "info" | "warn" | "error"; // Logging verbosity
  maxConcurrentPRs: number;   // Maximum concurrent PRs to handle
}
```

### AutomationContext
Represents the runtime context for automation operations.

```typescript
interface AutomationContext {
  config: AutomationConfig;   // Configuration for this automation run
  startTime: Date;            // When automation started
  endTime?: Date;             // When automation completed (if completed)
  currentState: "initialized" | "running" | "paused" | "completed" | "failed";
  currentTask?: string;       // ID of currently executing task
  progress: number;           // Progress percentage (0-100)
  results: IntegrationResult[]; // Results of completed PR integrations
  notificationsSent: number;  // Count of notifications sent
}
```

### AutomationTask
Extends IntegrationTask with automation-specific properties.

```typescript
interface AutomationTask extends IntegrationTask {
  automationId: string;       // ID of the automation workflow
  retryCount: number;         // Number of times this task has been retried
  maxRetries: number;         // Maximum number of retries allowed
  timeout: number;            // Timeout for this task in seconds
  dependenciesResolved: boolean; // Whether dependencies have been resolved
  automationMetadata: {
    startedAt?: Date;         // When this task started
    completedAt?: Date;       // When this task completed
    executionOrder: number;   // Order in which this task was executed
    workerId?: string;        // ID of the worker executing this task
  };
}
```