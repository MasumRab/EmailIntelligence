#!/bin/bash
# Post-commit hook for setup file validation (not distribution)
# This hook runs after each commit to validate setup files are properly synchronized

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Function to check if setup files were modified
setup_files_modified() {
    # Check if any files in the setup directory were added/modified in the last commit
    if git diff-tree --no-commit-id --name-only --diff-filter=AM HEAD | grep -q "^setup/"; then
        return 0  # Files were added or modified
    else
        return 1  # No setup files were added or modified
    fi
}

# Function to validate setup synchronization
validate_setup_sync() {
    echo "Setup files detected in commit, validating synchronization..."

    # Check if sync script exists
    if [[ -f "$PROJECT_ROOT/scripts/sync_setup_worktrees.sh" ]]; then
        echo "INFO: Setup sync script exists, validation may be needed"
        echo "Consider running: scripts/sync_setup_worktrees.sh --verify"
    else
        echo "WARNING: Setup sync script not found at $PROJECT_ROOT/scripts/sync_setup_worktrees.sh"
    fi
    
    # Verify essential setup files exist
    ESSENTIAL_SETUP_FILES=(
        "setup/launch.py"
        "setup/validation.py"
        "setup/environment.py"
        "setup/utils.py"
    )
    
    for file in "${ESSENTIAL_SETUP_FILES[@]}"; do
        if [[ ! -f "$PROJECT_ROOT/$file" ]]; then
            echo "WARNING: Essential setup file missing: $file"
        fi
    done
}

# Main execution
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$CURRENT_BRANCH" == "orchestration-tools" ]]; then
    echo "On orchestration-tools branch, validation will proceed"
fi

if setup_files_modified; then
    validate_setup_sync
else
    echo "No setup files added or modified in this commit, skipping validation"
fi

echo "Setup validation completed"