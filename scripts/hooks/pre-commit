#!/bin/bash

# Pre-commit hook for worktree setup validation
# Validates that shared setup files are only modified in orchestration-tools branch

set -e

# Get current branch
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"

# Check if setup/ directory has changes
if git diff --cached --name-only | grep -q "^setup/"; then
    if [[ "$CURRENT_BRANCH" != "orchestration-tools" ]]; then
        echo "ERROR: Changes to setup/ files should only be made in the 'orchestration-tools' branch."
        echo "Please commit setup changes to orchestration-tools branch instead."
        echo ""
        echo "To fix this:"
        echo "1. Stash your changes: git stash"
        echo "2. Switch to orchestration-tools: git checkout orchestration-tools"
        echo "3. Apply stash: git stash pop"
        echo "4. Commit there, then merge back"
        exit 1
    fi
fi

# Check if orchestration scripts have changes
if git diff --cached --name-only | grep -q "^scripts/sync_setup_worktrees.sh$"; then
    if [[ "$CURRENT_BRANCH" != "orchestration-tools" ]]; then
        echo "ERROR: Changes to orchestration scripts should only be made in the 'orchestration-tools' branch."
        exit 1
    fi
fi

# Check if shared config files have changes
SHARED_CONFIG_FILES=(
    ".flake8"
    ".pylintrc"
    "tsconfig.json"
    "package.json"
    "tailwind.config.ts"
    "vite.config.ts"
    "drizzle.config.ts"
    "components.json"
    ".gitignore"
    ".gitattributes"
)

for config_file in "${SHARED_CONFIG_FILES[@]}"; do
    if git diff --cached --name-only | grep -q "^${config_file}$"; then
        if [[ "$CURRENT_BRANCH" != "orchestration-tools" ]]; then
            echo "ERROR: Changes to shared config file '${config_file}' should only be made in the 'orchestration-tools' branch."
            exit 1
        fi
    fi
done

# Check if hooks have changes
if git diff --cached --name-only | grep -q "^scripts/hooks/"; then
    if [[ "$CURRENT_BRANCH" != "orchestration-tools" ]]; then
        echo "ERROR: Changes to Git hooks should only be made in the 'orchestration-tools' branch."
        exit 1
    fi
fi

echo "Pre-commit validation passed"
