#!/bin/bash

# Pre-commit hook for worktree setup validation
# Validates that shared setup files are only modified in orchestration-tools branch

set -e

# Get current branch
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"

# Check if setup/ directory has changes
if git diff --cached --name-only | grep -q "^setup/"; then
    if [[ "$CURRENT_BRANCH" != "orchestration-tools" ]]; then
        echo "WARNING: Changes to setup/ files detected on '$CURRENT_BRANCH' branch."
        echo "This will require a pull request to 'orchestration-tools' for approval."
        echo "Proceeding with commit, but ensure PR is created after push."
    fi
fi

# Check if orchestration scripts have changes
if git diff --cached --name-only | grep -q "^scripts/sync_setup_worktrees.sh$"; then
    if [[ "$CURRENT_BRANCH" != "orchestration-tools" ]]; then
        echo "WARNING: Changes to orchestration scripts detected on '$CURRENT_BRANCH' branch."
        echo "This will require a pull request to 'orchestration-tools' for approval."
    fi
fi

# Check if shared config files have changes
SHARED_CONFIG_FILES=(
    ".flake8"
    ".pylintrc"
    "tsconfig.json"
    "package.json"
    "tailwind.config.ts"
    "vite.config.ts"
    "drizzle.config.ts"
    "components.json"
    ".gitignore"
    ".gitattributes"
)

for config_file in "${SHARED_CONFIG_FILES[@]}"; do
    if git diff --cached --name-only | grep -q "^${config_file}$"; then
        if [[ "$CURRENT_BRANCH" != "orchestration-tools" ]]; then
            echo "WARNING: Changes to shared config file '${config_file}' detected on '$CURRENT_BRANCH' branch."
            echo "This will require a pull request to 'orchestration-tools' for approval."
        fi
    fi
done

# Check if hooks have changes
if git diff --cached --name-only | grep -q "^scripts/hooks/"; then
    if [[ "$CURRENT_BRANCH" != "orchestration-tools" ]]; then
        echo "WARNING: Changes to Git hooks detected on '$CURRENT_BRANCH' branch."
        echo "This will require a pull request to 'orchestration-tools' for approval."
    fi
fi

echo "Pre-commit validation passed"
