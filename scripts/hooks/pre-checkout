#!/bin/bash

# Pre-checkout hook to preserve work before switching branches
# This hook automatically stashes uncommitted changes to orchestration-managed files
# when switching branches, preventing work loss.

set -e

# Colors for output
YELLOW='\033[1;33m'
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Orchestration-managed files that should be preserved
ORCHESTRATION_MANAGED_FILES=(
    "setup/"
    "deployment/"
    ".flake8"
    ".pylintrc"
    ".gitignore"
    ".gitattributes"
    "pyproject.toml"
    "requirements.txt"
    "requirements-dev.txt"
    "launch.py"
    "launch.sh"
)

# Get the branch we're switching TO (passed as third argument)
NEW_BRANCH=$3

# Skip if switching to orchestration-tools (no stash needed there)
if [[ "$NEW_BRANCH" == "orchestration-tools" ]]; then
    exit 0
fi

# Check if there are any uncommitted changes to orchestration-managed files
has_orchestration_changes=0
orchestration_files_changed=()

for file_pattern in "${ORCHESTRATION_MANAGED_FILES[@]}"; do
    # Check both staged and unstaged changes
    if git diff --name-only | grep -q "^${file_pattern}" 2>/dev/null; then
        has_orchestration_changes=1
        while IFS= read -r file; do
            orchestration_files_changed+=("$file")
        done < <(git diff --name-only | grep "^${file_pattern}")
    fi
    
    if git diff --cached --name-only | grep -q "^${file_pattern}" 2>/dev/null; then
        has_orchestration_changes=1
        while IFS= read -r file; do
            orchestration_files_changed+=("$file")
        done < <(git diff --cached --name-only | grep "^${file_pattern}")
    fi
done

# If no orchestration files have changes, exit normally
if [[ $has_orchestration_changes -eq 0 ]]; then
    exit 0
fi

# We have uncommitted changes to orchestration-managed files
# Inform user and offer to stash them

echo ""
echo -e "${YELLOW}════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}⚠️  UNCOMMITTED ORCHESTRATION FILE CHANGES DETECTED${NC}"
echo -e "${YELLOW}════════════════════════════════════════════════════${NC}"
echo ""
echo "The following orchestration-managed files have uncommitted changes:"
echo ""
for file in "${orchestration_files_changed[@]}"; do
    echo -e "  ${RED}•${NC} $file"
done
echo ""
echo "Switching branches could lose this work!"
echo ""
echo -e "${GREEN}OPTIONS:${NC}"
echo "  1) ${GREEN}Stash changes${NC} and switch (work will be saved, recovery available)"
echo "  2) ${GREEN}Abort switch${NC} and commit/push changes first"
echo "  3) ${GREEN}Continue anyway${NC} (NOT RECOMMENDED - changes may be lost)"
echo ""
read -p "Choose (1-3): " -n 1 -r
echo ""
echo ""

case $REPLY in
    1)
        # Auto-stash with descriptive message
        STASH_MESSAGE="AUTO-STASH: orchestration files before switching to $NEW_BRANCH at $(date '+%Y-%m-%d %H:%M:%S')"
        
        echo -e "${YELLOW}Creating stash: $STASH_MESSAGE${NC}"
        
        if git stash push -u -m "$STASH_MESSAGE" -- "${orchestration_files_changed[@]}" 2>/dev/null; then
            echo -e "${GREEN}✓ Changes stashed successfully${NC}"
            echo ""
            echo "To recover this work later, use:"
            echo -e "  ${GREEN}git stash list${NC}              # See all stashes"
            echo -e "  ${GREEN}git stash apply stash@{0}${NC}   # Apply most recent stash"
            echo ""
            echo "Or use the recovery script:"
            echo -e "  ${GREEN}./scripts/recover_orphaned_work.sh scan${NC}"
            echo ""
            exit 0
        else
            echo -e "${RED}✗ Failed to create stash${NC}"
            exit 1
        fi
        ;;
    2)
        echo -e "${YELLOW}Branch switch aborted.${NC}"
        echo ""
        echo "To proceed, commit your changes:"
        echo -e "  ${GREEN}git add <files>${NC}"
        echo -e "  ${GREEN}git commit -m 'your message'${NC}"
        echo -e "  ${GREEN}git push origin <branch>${NC}"
        echo ""
        echo "Then switch branches."
        exit 1
        ;;
    3)
        echo -e "${RED}⚠️  Continuing without stashing changes.${NC}"
        echo "This may result in work loss. Proceed at your own risk."
        echo ""
        exit 0
        ;;
    *)
        echo -e "${YELLOW}Invalid choice. Aborting branch switch.${NC}"
        exit 1
        ;;
esac
