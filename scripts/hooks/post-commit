#!/bin/bash

# Post-commit hook for orchestration synchronization
# Ensures changes are properly synchronized across worktrees and branches

# Recursion prevention: Exit if sync is already active
if [[ "$ORCHESTRATION_SYNC_ACTIVE" == "1" ]]; then
    exit 0
fi

# Check for disable flag
if [[ "$DISABLE_ORCHESTRATION_CHECKS" == "1" ]]; then
    echo "Orchestration checks disabled, skipping post-commit sync"
    exit 0
fi

set -e

# Get current branch and commit info
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
COMMIT_HASH="$(git rev-parse HEAD)"
COMMIT_MESSAGE="$(git log -1 --pretty=%B)"

echo "Post-commit hook triggered on branch: $CURRENT_BRANCH"
echo "Commit: $COMMIT_HASH"

# Branch-specific post-commit actions
case "$CURRENT_BRANCH" in
    "orchestration-tools")
        echo "Running orchestration-tools post-commit actions..."

        # Validate orchestration scripts are still functional
        if [[ -f "emailintelligence_cli.py" ]]; then
            echo "✓ EmailIntelligence CLI present"
        else
            echo "WARNING: emailintelligence_cli.py missing after commit"
        fi

        # Check if orchestration scripts are executable
        for script in scripts/bash/*.sh; do
            if [[ -f "$script" && ! -x "$script" ]]; then
                echo "Fixing permissions for $script"
                chmod +x "$script"
            fi
        done

        # Validate hook consistency
        if [[ -f ".git/hooks/post-merge" ]]; then
            echo "✓ Post-merge hook present"
        else
            echo "WARNING: Post-merge hook missing"
        fi

        echo "✓ Orchestration-tools post-commit validation complete"
        ;;

    "main"|"scientific")
        echo "Running post-commit sync for $CURRENT_BRANCH..."

        # Check if this commit affects shared files that need syncing
        SHARED_FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep -E "\.(md|json|yml|yaml|cfg|ini)$" | wc -l)

        if [[ $SHARED_FILES_CHANGED -gt 0 ]]; then
            echo "Shared configuration files changed - checking sync status..."

            # Validate setup directory integrity
            if [[ -d "setup" && -f "setup/setup_environment_system.sh" ]]; then
                echo "✓ Setup directory synchronized"
            else
                echo "WARNING: Setup directory may need synchronization"
            fi
        fi

        # Check Task Master compatibility if .taskmaster exists
        if [[ -d ".taskmaster" ]]; then
            if [[ -f ".taskmaster/tasks/tasks.json" ]]; then
                echo "✓ Task Master tasks database present"
            else
                echo "WARNING: Task Master tasks database missing"
            fi
        fi

        echo "✓ Post-commit sync validation complete"
        ;;

    "taskmaster")
        echo "Running Task Master post-commit actions..."

        # Validate Task Master files
        if [[ ! -f "AGENT.md" ]]; then
            echo "ERROR: AGENT.md missing from Task Master branch"
            exit 1
        fi

        # Check for task-related changes
        TASK_FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep -E "\.taskmaster|tasks/" | wc -l)

        if [[ $TASK_FILES_CHANGED -gt 0 ]]; then
            echo "Task-related files changed - validating Task Master integrity..."

            # Validate task JSON structure
            if [[ -f ".taskmaster/tasks/tasks.json" ]]; then
                if python3 -m json.tool ".taskmaster/tasks/tasks.json" >/dev/null 2>&1; then
                    echo "✓ Task Master JSON is valid"
                else
                    echo "ERROR: Task Master JSON is malformed"
                    exit 1
                fi
            fi
        fi

        echo "✓ Task Master post-commit validation complete"
        ;;

    *)
        echo "Running generic post-commit checks for branch: $CURRENT_BRANCH"
        ;;
esac

# Common post-commit actions for all branches

# Check for large commits (potential issues)
COMMIT_SIZE=$(git diff-tree --no-commit-id --stat HEAD | tail -1 | awk '{print $4+$6}')
if [[ $COMMIT_SIZE -gt 100 ]]; then
    echo "Large commit detected ($COMMIT_SIZE changes) - consider splitting if unrelated"
fi

# Log commit for orchestration tracking
if [[ -n "$ORCHESTRATION_LOG" ]]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') $CURRENT_BRANCH $COMMIT_HASH $COMMIT_MESSAGE" >> "$ORCHESTRATION_LOG"
fi

echo "✓ Post-commit hook completed successfully"