#!/bin/bash

# Post-push hook for all branches
# Handles orchestration sync and reverse flow coordination

set -e

CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"

# Parse push output from stdin (Git provides ref info)
while read local_ref local_sha remote_ref remote_sha; do
    echo "Push detected: $local_ref ($local_sha ‚Üí $remote_sha)"

    if [[ "$local_ref" == "refs/heads/orchestration-tools" ]]; then
        # Orchestration-tools pushed - trigger worktree sync
        echo "orchestration-tools branch pushed, running sync tasks..."
        echo "Push completed at $(date)"
        echo "Remote SHA: $remote_sha"

        # Could trigger: CI, notifications, worktree sync
        exit 0

    elif [[ "$CURRENT_BRANCH" != "orchestration-tools" ]]; then
        # Other branch pushed - check for orchestration changes
        check_orchestration_changes "$local_sha" "$remote_sha"
    fi
done

check_orchestration_changes() {
    local old_sha="$1"
    local new_sha="$2"

    # Check if managed files were changed in this push
    MANAGED_FILES=(
        "setup/launch.py"
        "setup/launch.bat"
        "setup/launch.sh"
        "scripts/sync_setup_worktrees.sh"
        ".flake8"
        ".pylintrc"
        "tsconfig.json"
        "package.json"
        "tailwind.config.ts"
        "vite.config.ts"
        "drizzle.config.ts"
        "components.json"
        ".gitignore"
        ".gitattributes"
    )

    CHANGED_FILES=$(git diff --name-only "$old_sha" "$new_sha")

    ORCHESTRATION_CHANGES=false
    for file in "${MANAGED_FILES[@]}"; do
        if echo "$CHANGED_FILES" | grep -q "^${file}$"; then
            ORCHESTRATION_CHANGES=true
            break
        fi
    done

    if [[ "$ORCHESTRATION_CHANGES" == true ]]; then
        CHANGED_ORCHESTRATION_FILES=$(echo "$CHANGED_FILES" | grep -E "$(printf '%s|' "${MANAGED_FILES[@]}" | sed 's/|$//')")

        echo "‚ö†Ô∏è  ORCHESTRATION CHANGES DETECTED on branch '$CURRENT_BRANCH'"
        echo "   Files changed: $CHANGED_ORCHESTRATION_FILES"
        echo ""
        echo "   IMPORTANT: These files are managed by the orchestration-tools branch."
        echo "   Changes here will be OVERWRITTEN when this branch pulls from orchestration-tools."
        echo ""

        # Attempt to create automatic draft PR
        create_automatic_pr "$CURRENT_BRANCH" "$new_sha" "$CHANGED_ORCHESTRATION_FILES"
    fi
}

create_automatic_pr() {
    local branch="$1"
    local commit_sha="$2"
    local changed_files="$3"

    echo "ü§ñ Attempting to create automatic draft PR..."

    # Check if GitHub CLI is available
    if ! command -v gh &> /dev/null; then
        echo "‚ùå GitHub CLI (gh) not available. Manual PR creation required."
        show_manual_pr_instructions "$branch" "$commit_sha"
        return 1
    fi

    # Check if authenticated
    if ! gh auth status &> /dev/null; then
        echo "‚ùå GitHub CLI not authenticated. Manual PR creation required."
        show_manual_pr_instructions "$branch" "$commit_sha"
        return 1
    fi

    # Get commit information
    local commit_title=$(git log -1 --format="%s" "$commit_sha")
    local commit_body=$(git log -1 --format="%b" "$commit_sha")

    # Create PR title
    local pr_title="[AUTO] Orchestration changes: $commit_title"

    # Create PR body
    local pr_body=$(cat << EOF
## ü§ñ Automatically Created Draft PR

**Source Branch:** \`$branch\`  
**Commit:** \`$commit_sha\`  
**Detected:** Orchestration-managed files changed

### Files Changed
$changed_files

### Commit Details
**Title:** $commit_title
**Description:**
$commit_body

### Orchestration Impact
These changes affect orchestration-managed files that are synchronized across all branches and worktrees. This PR ensures proper review before these changes become the canonical source.

### Next Steps
1. **Review** the changes carefully
2. **Test** the functionality on multiple platforms
3. **Assess impact** on existing branches
4. **Promote from draft** when ready for review
5. **Merge** to orchestration-tools after approval

### ‚ö†Ô∏è Important Notes
- This PR was auto-created to ensure orchestration changes go through review
- All orchestration-managed files require PR review before propagation
- Changes will automatically sync to all branches after merge

---
*Auto-generated by orchestration post-push hook*
EOF
)

    # Create the draft PR
    echo "üìù Creating draft PR: '$pr_title'"
    if gh pr create \
        --draft \
        --base orchestration-tools \
        --head "$branch" \
        --title "$pr_title" \
        --body "$pr_body" \
        --label "orchestration,auto-created"; then

        local pr_url=$(gh pr view --json url -q .url 2>/dev/null || echo "")

        echo ""
        echo "‚úÖ DRAFT PR CREATED SUCCESSFULLY!"
        if [[ -n "$pr_url" ]]; then
            echo "üîó PR URL: $pr_url"
        fi
        echo ""
        echo "üìã Next Steps:"
        echo "1. Review the auto-generated PR"
        echo "2. Test changes thoroughly"
        echo "3. Mark as ready for review when prepared"
        echo "4. Request reviews from orchestration maintainers"
        echo ""
        echo "‚ö†Ô∏è  REMEMBER: Do not merge until fully tested and approved!"
        echo "   Orchestration changes affect ALL branches and worktrees."

    else
        echo "‚ùå Failed to create draft PR automatically."
        echo "   This may be due to network issues, permissions, or branch conflicts."
        show_manual_pr_instructions "$branch" "$commit_sha"
    fi
}

show_manual_pr_instructions() {
    local branch="$1"
    local commit_sha="$2"

    echo ""
    echo "üìã MANUAL PR CREATION REQUIRED:"
    echo ""
    echo "1. Go to: https://github.com/MasumRab/EmailIntelligence/pulls"
    echo "2. Click 'New Pull Request'"
    echo "3. Set:"
    echo "   - Base: orchestration-tools"
    echo "   - Compare: $branch"
    echo "4. Select PR template: 'orchestration-pr.md'"
    echo "5. Fill out the impact assessment and testing plan"
    echo "6. Request reviews from orchestration maintainers"
    echo ""
    echo "üîß For urgent fixes only:"
    echo "   ./scripts/reverse_sync_orchestration.sh $branch $commit_sha"
}
}

echo "Post-push hook completed"
