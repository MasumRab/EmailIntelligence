#!/bin/bash
# Pre-commit hook to check for misplaced documentation files

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check for misplaced markdown files
MISPLACED_FILES=()

for file in $STAGED_FILES; do
    if [[ "$file" == *.md ]]; then
        # Check if file is in appropriate location
        if [[ "$file" == docs/* ]] || [[ "$file" == backlog/* ]] || [[ "$file" == worktrees/docs-main/docs/* ]] || [[ "$file" == worktrees/docs-main/backlog/* ]] || [[ "$file" == worktrees/docs-scientific/docs/* ]] || [[ "$file" == worktrees/docs-scientific/backlog/* ]]; then
            # File is in correct location
            continue
        else
            # Allow README.md files in code directories
            if [[ "$file" == */README.md ]]; then
                continue
            fi
            # Check if file is in forbidden location
            if [[ "$file" == src/* ]] || [[ "$file" == python_backend/* ]] || [[ "$file" == client/* ]] || [[ "$file" == backend/* ]] || [[ "$file" == modules/* ]] || [[ "$file" == tests/* ]] || [[ "$file" == scripts/* ]] || [[ "$file" == deployment/* ]] || [[ "$file" == config/* ]] || [[ "$file" == data/* ]] || [[ "$file" == models/* ]] || [[ "$file" == plugins/* ]] || [[ "$file" == shared/* ]] || [[ "$file" == venv/* ]] || [[ "$file" == node_modules/* ]] || [[ "$file" == __pycache__/* ]] || [[ "$file" == .git/* ]] || [[ "$file" == .github/* ]] || [[ "$file" == logs/* ]]; then
                MISPLACED_FILES+=("$file")
            fi
        fi
    fi
done

# Report misplaced files
if [ ${#MISPLACED_FILES[@]} -gt 0 ]; then
    echo -e "${RED}❌ Pre-commit check failed: Misplaced documentation files detected${NC}"
    echo ""
    echo "The following documentation files are in incorrect locations:"
    echo ""

    for file in "${MISPLACED_FILES[@]}"; do
        echo -e "  ${YELLOW}✗ $file${NC}"

        # Suggest correct location
        if [[ "$file" == worktrees/docs-main/* ]]; then
            echo -e "    Suggested: worktrees/docs-main/docs/main/$(basename "$file")"
        elif [[ "$file" == worktrees/docs-scientific/* ]]; then
            echo -e "    Suggested: worktrees/docs-scientific/docs/scientific/$(basename "$file")"
        else
            echo -e "    Suggested: docs/$(basename "$file")"
        fi
        echo ""
    done

    echo "To fix this automatically, run:"
    echo "  python scripts/maintenance_docs.py --fix-misplaced"
    echo ""
    echo "Or move the files manually to the correct locations and try again."
    echo ""

    exit 1
fi

echo -e "✅ Pre-commit check passed: No misplaced documentation files"
exit 0